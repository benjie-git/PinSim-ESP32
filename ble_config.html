<!DOCTYPE html>
<html lang="en-US">
<head>
    <title>PinSim Web Configurator</title>
    <style>
        body {
            background: #EDC;
        }
        .outer-section {
            background: #BDF;
            border: solid 1px;
            border-radius: 5px;
            padding: 0 20px 20px 10px;
            margin-bottom: 10px;
        }
        .inner-section {
            padding-left: 20px;
        }
        #conn-status button {
            position: relative;
            height: 28px;
        }
        #conn-error {
            color: #BB2222;
            font-weight: bold;
            padding-top: 6px;
        }
        .pinsim-box {
            position: relative;
            margin-top: 20px;
            border: solid 2px #000;
            border-radius: 10px;
            background: #FFF;
            height: 260px;
            width: 650px;
        }
        div.button {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            position: absolute;
            background: #FFF;
            border: solid 3px #000;
            border-radius: 40px;
            width: 45px;
            height: 43px;
            padding-top: 2px;
        }
        div.button.pressed {
            background: #38F;
        }
        div.button.keyMap {
            border-color: #F00;
        }
        input[type="radio"]:checked + label {
            font-weight: bold;
        }
        .disabled {
            color: grey;
        }
        div.disabled button {
            opacity: 0.6; /* Make it slightly transparent */
            cursor: not-allowed; /* Change cursor on hover */
            background-color: #ccc; /* Gray background */
            color: #222; /* Lighter text color */
            pointer-events: none; /* Prevent click events */
        }
        .vbar-container {
            position: absolute;
            border: solid 2px #555;
            width: 16px;
            height: 115px;
            background-color: #ddd;
            border-radius: 3px;
            overflow: hidden;
        }
        .stick-visual {
            position: absolute;
            width: 100px;
            height: 100px;
            border: 2px solid #555;
            border-radius: 50%;
            margin: 10px auto;
            background-color: #ddd;
        }
        .thumbstick {
            position: absolute;
            width: 16px;
            height: 16px;
            background-color: red;
            border-radius: 50%;
            top: 42px;
            left: 42px;
            transform: translate(0, 0);
            transition: background-color 0.1s;
        }

        /* Connecting... animation */
        .loader {
            position: absolute;
            left: 80%;
            width: 18px;
            aspect-ratio: 1;
            display: inline-grid;
            border-radius: 50%;
            background:
                    linear-gradient(0deg ,rgb(0 0 0/50%) 30%,#0000 0 70%,rgb(0 0 0/100%) 0) 50%/8% 100%,
                    linear-gradient(90deg,rgb(0 0 0/25%) 30%,#0000 0 70%,rgb(0 0 0/75% ) 0) 50%/100% 8%;
            background-repeat: no-repeat;
            animation: l23 1s infinite steps(12);
        }
        .loader::before,
        .loader::after {
            content: "";
            grid-area: 1/1;
            border-radius: 50%;
            background: inherit;
            opacity: 0.915;
            transform: rotate(30deg);
        }
        .loader::after {
            opacity: 0.83;
            transform: rotate(60deg);
        }
        @keyframes l23 {
            100% {transform: rotate(1turn)}
        }
    </style>
</head>

<body>
<h1>PinSim Web Configurator</h1>

<div class="outer-section">
    <h2 style="display: inline-block">
        PinSim Devices:
        <button id="scan-button" onclick="scanForDevices()">Scan...</button>
    </h2>
    <a href="javascript:0" id="edit-link" onclick="editDevicesMode = !editDevicesMode; showAllowedDevices()">[Edit]</a><br/>
    <div id="conn-status-enabled" style="display: inline-block"></div>
    <div id="conn-status-disabled" class="disabled" style="display: inline-block"><span>No Devices Found</span></div>
    <div id="conn-error"></div>
</div>

<div class="outer-section">
    <div id="gamepad-controls" class="inner-section disabled">
        <h2>
            PinSim Controls <span id="gamepad-label-pinsimID"></span>
            <button id="disconnect-button" onclick="disconnect()">Disconnect</button>
        </h2>
        <div class="pinsim-box">
            <div id="button-status-l-flipper" class="button" style="left: 20px; top: 120px;">L<div class="key"></div></div>
            <div id="button-status-r-flipper" class="button" style="left: 585px; top: 120px;">R<div class="key"></div></div>

            <div id="button-status-back" class="button" style="left: 80px; top: 20px;">Back<div class="key"></div></div>
            <div id="button-status-menu" class="button" style="left: 130px; top: 20px;">Menu<div class="key"></div></div>
            <div id="button-status-start" class="button" style="left: 65px; top: 195px;">Start<div class="key"></div></div>

            <div id="button-status-dpad-up" class="button" style="left: 270px; top: 25px;">Up<div class="key"></div></div>
            <div id="button-status-dpad-down" class="button" style="left: 270px; top: 95px;">Down<div class="key"></div></div>
            <div id="button-status-dpad-left" class="button" style="left: 235px; top: 60px;">Left<div class="key"></div></div>
            <div id="button-status-dpad-right" class="button" style="left: 305px; top: 60px;">Right<div class="key"></div></div>

            <div id="button-status-x" class="button" style="left: 400px; top: 20px;">X<div class="key"></div></div>
            <div id="button-status-y" class="button" style="left: 450px; top: 20px;">Y<div class="key"></div></div>
            <div id="button-status-z" class="button" style="left: 500px; top: 20px;">Z<div class="key"></div></div>
            <div id="button-status-a" class="button" style="left: 400px; top: 70px;">A<div class="key"></div></div>
            <div id="button-status-b" class="button" style="left: 450px; top: 70px;">B<div class="key"></div></div>
            <div id="button-status-c" class="button" style="left: 500px; top: 70px;">C<div class="key"></div></div>

            <button id="end-mapping" onclick="setKeyMapUI(0)" style="left: 575px; top: 15px; display: none; position: absolute;">Done</button>

            <div class="stick-visual" style="left: 150px; top: 120px;">
                <div id="left-stick" class="thumbstick"></div>
            </div>
            <span style="position: absolute; left: 170px; top: 240px;">Left Stick</span>

            <div class="vbar-container" style="left: 520px; top: 143px;">
                <div id="right-stick" class="thumbstick" style="left: 0; top: 0;"></div>
            </div>
            <span id="plunger" style="position: absolute; left: 545px; top: 240px;">Right Stick <span class="key"></span></span>

            <table style="position: absolute; left: 320px; top: 190px;">
                <tr><th align="right">Pairings:</th><td id="gamepad-status-pairings"></td></tr>
                <tr><th align="right">Plunger Stick:</th><td id="gamepad-status-plunger-stick"></td></tr>
                <tr><th align="right">Solenoids:</th><td id="gamepad-status-solenoids"></td></tr>
            </table>

            <div style="height: 220px;"></div>
        </div>
    </div>

    <div id="ble-section" class="inner-section disabled">
        <h3>Bluetooth Pairing</h3>
        <div class="inner-section">
            <button onclick="const i = Math.max(0, Math.min(255, prompt('New PinSim ID (0-255)'))); sendCommand(COMMAND_SET_PINSIM_ID, i);">Set PinSim ID...</button>
            <button onclick="sendCommand(COMMAND_PAIR_START)">Start Pairing Mode</button>
            <button onclick="sendCommand(COMMAND_PAIR_CLEAR)">Clear All Pairing Info</button>
        </div>

        <h3>Calibration</h3>
        <div class="inner-section">
            <table>
                <tr>
                    <th>Tilt Sensor:</th><td>
                        <button onclick="sendCommand(COMMAND_ACCEL_CAL)">Calibrate</button>
                    </td>
                </tr>
                <tr>
                    <th>Plunger:</th><td>
                        <button id="button-plunger-min" onclick="sendCommand(COMMAND_PLUNGER_SET_MIN); document.getElementById('button-plunger-max').focus();">Set Min</button>
                        <button id="button-plunger-max" onclick="sendCommand(COMMAND_PLUNGER_SET_MAX); document.getElementById('button-plunger-zero').focus();">Set Max</button>
                        <button id="button-plunger-zero" onclick="sendCommand(COMMAND_PLUNGER_SET_ZERO); document.getElementById('button-plunger-min').focus();">Set Zero (Dead Zone)</button>
                    </td>
                </tr>
            </table>
        </div>

        <h3>Control Toggles</h3>
        <div class="inner-section">
            <button onclick="sendCommand(COMMAND_TOGGLE_CONTROL_SWAP)">Swap Plunger Controls</button>
            <button onclick="sendCommand(COMMAND_TOGGLE_SOLENOIDS)">Toggle Solenoids</button>
            <button onclick="sendCommand(COMMAND_TOGGLE_KEYBOARD)">Toggle Keyboard/Gamepad Mode</button>
        </div>

        <h3>Testing</h3>
        <div class="inner-section">
            <button onmousedown="sendCommand(COMMAND_FIRE_SOLENOID,0,1)" onmouseup="sendCommand(COMMAND_FIRE_SOLENOID,0,0)">Test Left Solenoid</button>
            <button onmousedown="sendCommand(COMMAND_FIRE_SOLENOID,1,1)" onmouseup="sendCommand(COMMAND_FIRE_SOLENOID,1,0)">Test Right Solenoid</button>
        </div>

        <div id="key-mapping-commands" class="disabled">
            <h3>Key Mapping</h3>
            <div class="inner-section">
                <button onclick="sendCommand(COMMAND_RESET_KEY_MAPPING)">Reset to Default Key Map</button>
                <button id="start-mapping" onclick="setKeyMapUI(1)">Start Mapping Keys...</button>
            </div>
        </div>
    </div>
</div>

<script type="application/javascript">
    // Command num goes in commandData[0]
    const COMMAND_ACCEL_CAL           = 3
    const COMMAND_PLUNGER_SET_MIN     = 4
    const COMMAND_PLUNGER_SET_MAX     = 5
    const COMMAND_PLUNGER_SET_ZERO    = 6
    const COMMAND_TOGGLE_CONTROL_SWAP = 7
    const COMMAND_TOGGLE_SOLENOIDS    = 8
    const COMMAND_PAIR_CLEAR          = 9
    const COMMAND_PAIR_START          = 10
    const COMMAND_TOGGLE_KEYBOARD     = 11
    const COMMAND_SEND_STATUS         = 12
    const COMMAND_SET_PINSIM_ID       = 13  // commandData[1] contains id
    const COMMAND_SET_KEY_MAPPING     = 14  // commandData[1] contains button index, [2]: ord(char) for the new key
    const COMMAND_RESET_KEY_MAPPING   = 15
    const COMMAND_SET_SOLENOIDS       = 16  // commandData[1] contains bool for solenoids enabled
    const COMMAND_FIRE_SOLENOID       = 17  // commandData[1] contains isLeft(bool), [2]: isPressed(bool)

    // Command response num in commandData[0]
    const COMMAND_RESPONSE_STATUS     = 130  // 4 bytes
    const COMMAND_RESPONSE_KEYMAP     = 131  // 17 bytes

    const COMMAND_STATUS_PLUNGER_CONTROL_RIGHT    = 1
    const COMMAND_STATUS_SOLENOIDS_ENABLED        = 2
    const COMMAND_STATUS_KEYBOARD_MODE            = 4

    const COMMAND_VERSION                   = [0,2]
    const COMMAND_SERVICE_ID                = "4a761e27-a006-4b89-8d76-1c4b9e2402d4"
    const COMMAND_CHARACTERISTIC_ID         = "4a761e27-a006-4b89-8d76-1c4b9e2402d5"
    const COMMAND_VERSION_CHARACTERISTIC_ID = "4a761e27-a006-4b89-8d76-1c4b9e2402d6"
    const BLE_STALE_TIME                    = 60000

    const connStatusEnabledElement = document.getElementById("conn-status-enabled")
    const connStatusDisabledElement = document.getElementById("conn-status-disabled")
    const connErrorElement = document.getElementById("conn-error")
    const pinsimLabelElement = document.getElementById("gamepad-label-pinsimID")
    const pairingsStatusElement = document.getElementById("gamepad-status-pairings")
    const plungerStickStatusElement = document.getElementById("gamepad-status-plunger-stick")
    const solenoidsStatusElement = document.getElementById("gamepad-status-solenoids")
    const gamepadSectionElement = document.getElementById("gamepad-controls")
    const bleSectionElement = document.getElementById("ble-section")
    const disconnectButtonElement = document.getElementById("disconnect-button")
    const leftStickElement = document.getElementById('left-stick')
    const rightStickElement = document.getElementById('right-stick')
    const keyMappingCommandsElement = document.getElementById("key-mapping-commands")
    const editLinkElement = document.getElementById("edit-link")
    const startMappingKeysElement = document.getElementById("start-mapping")
    const endMappingKeysElement = document.getElementById("end-mapping")

    const buttonMap = [
        "button-status-a", "button-status-b", "button-status-x", "button-status-y",
        "button-status-l-flipper", "button-status-r-flipper", "", "",
        "button-status-back", "button-status-start", "button-status-c", "button-status-z",
        "button-status-dpad-up", "button-status-dpad-down", "button-status-dpad-left", "button-status-dpad-right",
        "button-status-menu"
    ]

    const keyMapButtonOrder = [
        "button-status-dpad-up",
        "button-status-dpad-down",
        "button-status-dpad-left",
        "button-status-dpad-right",
        "button-status-a",
        "button-status-b",
        "button-status-x",
        "button-status-y",
        "button-status-l-flipper",
        "button-status-r-flipper",
        "button-status-start",
        "button-status-back",
        "button-status-menu",
        "button-status-c",
        "button-status-z",
        "plunger",
    ]

    let keyMap = [
        "a",
        "s",
        "f",
        "d",
        "1",
        "b",
        "x",
        "y",
        "u",
        "6",
        "Enter",
        "i",
        "m",
        "c",
        "z",
        "8",
    ]

    const keyCodeMap = {
        0x80: "ControlLeft",
        0x81: "ShiftLeft",
        0x82: "AltLeft",
        0x83: "MetaLeft",
        0x84: "ControlRight",
        0x85: "ShiftRight",
        0x86: "AltRight",
        0x87: "MetaRight",
        0xDA: "ArrowUp",
        0xD9: "ArrowDown",
        0xD8: "ArrowLeft",
        0xD7: "ArrowRight",
        0x09: "Tab",
        0x0A: "Enter",
        0xB0: "Return",
        0xB1: "Escape",
        0xD4: "Delete",
        0xB2: "Backspace",
        0xC1: "CapsLock",
    }

    const modifierKeys = ["Shift", "Alt", "Control", "Meta"]

    const keyCodeMapInv = {
        "ControlLeft": 0x80,
        "ShiftLeft": 0x81,
        "AltLeft": 0x82,
        "MetaLeft": 0x83,
        "ControlRight": 0x84,
        "ShiftRight": 0x85,
        "AltRight": 0x86,
        "MetaRight": 0x87,
        "ArrowUp": 0xDA,
        "ArrowDown": 0xD9,
        "ArrowLeft": 0xD8,
        "ArrowRight": 0xD7,
        "Tab": 0x09,
        "Enter": 0x0A,
        "Return": 0xB0,
        "Escape": 0xB1,
        "Delete": 0xD4,
        "Backspace": 0xB2,
        "CapsLock": 0xC1,
    }

    const keyCodeDisplayMap = {
        "ControlLeft": "LCtrl",
        "ShiftLeft": "LShift",
        "AltLeft": "LAlt",
        "MetaLeft": "LCmd",
        "ControlRight": "RCtrl",
        "ShiftRight": "RShift",
        "AltRight": "RAlt",
        "MetaRight": "RCmd",
        "ArrowUp": "Up",
        "ArrowDown": "Down",
        "ArrowLeft": "Left",
        "ArrowRight": "Right",
        "Backspace": "Bkspace",
        "CapsLock": "Caps",
    }
    // Set up event listeners
    window.addEventListener("gamepadconnected", (event) => { connectGamepadWithPinsimID() })
    window.addEventListener("keydown", onKeyDown)
    window.addEventListener("keyup", onKeyUp)
    for (let i in keyMapButtonOrder) {
        document.getElementById(keyMapButtonOrder[i]).addEventListener("click", (e) => {onClickButton(e, i, 0)})
        document.getElementById(keyMapButtonOrder[i]).addEventListener("dblclick", (e) => {onClickButton(e, i, 1)})
    }

    const leftTriggerIndex = 6
    const rightTriggerIndex = 7

    let gamepadIndex = null  // Index of the currently selected gamepad
    let cmdCharacteristic = null
    let cmdDevice = null
    let plungerOnLeftStick = false
    let solenoidEnabled = false
    let keyboardMode = false
    let lastTimestamp = 0
    let pinsimID = null
    let kbGetKeyMode = 0  // 0=Idle, 1=GetButton, 2=GetKey, 3=Send&End
    let kbGetKeyData = [null, null]  // Button index, and key code for new mapping
    let editDevicesMode = false // When true, show [X] links next to each known device
    let connErrTimer = null
    let seenAdvertisements = []
    let watchingDevices = []

    /////////////////////////////////////
    // Connection-related functions

    function showAllowedDevices() {
        connStatusEnabledElement.classList.remove('disabled')
        if (navigator.bluetooth.getDevices === undefined) {
            connStatusEnabledElement.innerHTML = 'To use the PinSim web config tool, please enable the Chrome flags:<br/>\n\
  <b>chrome://flags#enable-experimental-web-platform-features</b> <a href="javascript:0" onclick="navigator.clipboard.writeText(\'chrome://flags#enable-experimental-web-platform-features\');">[Copy Link]</a><br/>\n\
  <b>chrome://flags#enable-web-bluetooth-new-permissions-backend</b> <a href="javascript:0" onclick="navigator.clipboard.writeText(\'chrome://flags#enable-web-bluetooth-new-permissions-backend\');">[Copy Link]</a>'
        }
        else {
            console.log('Getting Allowed Bluetooth Devices...')
            navigator.bluetooth.getDevices().then(devices => {
                console.log(`Found ${devices.length} BLE Device/s.`)
                let enabledHtml = ""
                let disabledHtml = ""
                if (devices.length >= 1) {
                    for (let device of devices) {
                        if (device) {
                            let devName = localStorage.getItem(`PinSimDisplayName-${device.id}`)
                            if (devName === null) devName = "Unknown Device"
                            const seen = (seenAdvertisements[device.id] && seenAdvertisements[device.id] > Date.now() - BLE_STALE_TIME)
                            const icon = (seen) ? "ðŸ“¶" : "âƒ "
                            let buttonHtml = ""
                            buttonHtml += `<button onclick="connectToDeviceWithId('${device.id}', this)"><span id="icon-${device.id}">${icon}</span> ${devName}</button>`
                            if (editDevicesMode) {
                                buttonHtml += `<a href="javascript:0" onclick="forgetDevice('${device.id}')">[X]</a>`
                            }
                            buttonHtml += " "
                            if (seen) {
                                enabledHtml += buttonHtml
                            } else {
                                disabledHtml += buttonHtml
                            }
                            if (!watchingDevices.includes(device.id)) {
                                watchingDevices += device.id
                                device.addEventListener("advertisementreceived", (event) => {
                                    console.log(`adv: ${device.id}`)
                                    const oldSeen = (seenAdvertisements[device.id] && seenAdvertisements[device.id] > Date.now() - BLE_STALE_TIME)
                                    seenAdvertisements[device.id] = Date.now()
                                    if (!oldSeen) {
                                        showAllowedDevices()
                                    } else {
                                        document.getElementById(`icon-${device.id}`).innerHTML = "ðŸ“¶"
                                    }
                                    device.watchAdvertisements()
                                })
                            }
                            device.watchAdvertisements()
                        }
                    }
                    connStatusEnabledElement.innerHTML = enabledHtml
                    connStatusDisabledElement.innerHTML = disabledHtml
                    if (editDevicesMode) {
                        connStatusEnabledElement.classList.add("disabled")
                    } else {
                        connStatusEnabledElement.classList.remove("disabled")
                    }
                }
                else {
                    connStatusDisabledElement.innerHTML = '<span>No Devices Found</span>'
                }
            }).catch((e) => {
                connStatusDisabledElement.innerHTML = '<span>No Devices Found</span>'
                showError(`Error Listing Devices (${e})`)
            })
        }
        editLinkElement.innerText = (editDevicesMode) ? "[Done]" : "[Edit]"
    }
    showAllowedDevices()

    function scanForDevices() {
        console.log('Requesting Bluetooth Device...')
        navigator.bluetooth.requestDevice({ acceptAllDevices: true,
            optionalServices: [COMMAND_SERVICE_ID]
        }).then(device => {
            if (device) {
                connectToDevice(device)
            }
            else {
                showAllowedDevices()
            }
        }).catch((e) => {
            console.log(e)
            if (e.name === "NotFoundError" && e.code === 8) {
                // skip "User cancelled the requestDevice() chooser" error
            } else {
                showError(`Error Scanning for Devices (${e})`)
            }
            showAllowedDevices()
        })
    }

    function forgetDevice(deviceId) {
        navigator.bluetooth.getDevices().then(devices => {
            for (let device of devices) {
                if (device.id === deviceId) {
                    if (devices.length === 1)
                        editDevicesMode = false
                    device.forget()
                    showAllowedDevices()
                }
            }
        })
    }

    function connectToDevice(device) {
        if (cmdDevice === device)
            return

        disconnect()
        device.gatt.connect().then(gatt => {
            cmdDevice = gatt.device
            console.log('Getting Service...')
            return gatt.getPrimaryService(COMMAND_SERVICE_ID)
        }).then(async service => {
            console.log('Getting Characteristics...')
            const characteristic = await service.getCharacteristic(COMMAND_VERSION_CHARACTERISTIC_ID)
            if (characteristic) {
                const v = await characteristic.readValue()
                if (v.getUint8(0) !== COMMAND_VERSION[0] || v.getUint8(1) !== COMMAND_VERSION[1]) {
                    throw Error('Bad PinSim Command Version')
                }
            }
            else {
                throw Error('PinSim Command Version Missing')
            }
            return service.getCharacteristic(COMMAND_CHARACTERISTIC_ID)
        }).then(characteristic => {
            cmdCharacteristic = characteristic
            cmdDevice.addEventListener('gattserverdisconnected', onDisconnect)
            console.log('Requesting Notifications...')
            return cmdCharacteristic.startNotifications()
        }).then(_ => {
            if (cmdCharacteristic.properties.notify) {
                onConnect()
            }
            else {
                console.log('Notifications not available.')
                didDisconnect(cmdDevice)
            }
        }).catch((e) => {
            console.log(e)
            showError(`Error Connecting to Device (${e})`)
            if (e.name === "NetworkError" && e.code === 19) {
                // On "Device is no longer in range" error, do nothing
            } else {
                forgetDevice(device.id)
            }
            showAllowedDevices()
        })
    }

    function connectToDeviceWithId(id, button) {
        navigator.bluetooth.getDevices().then(devices => {
            for (let device of devices) {
                if (device.id === id && device !== cmdDevice) {
                    connStatusEnabledElement.classList.add('disabled')
                    button.insertAdjacentHTML('beforeend', ' <div class="loader"></div>')
                    connectToDevice(device)
                    break
                }
            }
        })
    }

    function showError(err) {
        if (err === null) {
            connErrorElement.innerHTML = ""
            connErrTimer = null
        } else {
            connErrorElement.innerHTML = err
            if (connErrTimer !== null) clearTimeout(connErrTimer)
            connErrTimer = setTimeout(() => {
                connErrorElement.innerHTML = ""
                connErrTimer = null
            }, 5000)
        }
    }

    function onConnect() {
        showError(null)
        cmdCharacteristic.addEventListener("characteristicvaluechanged", onResponse);
        console.log('Notifications started.')
        gamepadSectionElement.classList.remove("disabled")
        bleSectionElement.classList.remove("disabled")
        disconnectButtonElement.classList.remove("disabled")
        setKeyMapUI(0)
        showAllowedDevices()
        sendCommand(COMMAND_SEND_STATUS)
    }

    function onDisconnect(event) {
        didDisconnect(event.target)
    }

    function didDisconnect(device) {
        if (device === cmdDevice) {
            cmdCharacteristic = null
            cmdDevice = null
            gamepadIndex = null
            pairingsStatusElement.innerHTML = ""
            plungerStickStatusElement.innerHTML = ""
            solenoidsStatusElement.innerHTML = ""
            gamepadSectionElement.classList.add("disabled")
            bleSectionElement.classList.add("disabled")
            disconnectButtonElement.classList.add("disabled")
            keyMappingCommandsElement.classList.add("disabled")
            setKeyMapUI(0)
            showAllowedDevices()
            displayKeys()
            updateStick(leftStickElement, 0, 0, 40)
            updateStick(rightStickElement, 0, 0, 100)
        }
    }

    function disconnect() {
        if (cmdDevice) {
            cmdDevice.gatt.disconnect()
        }
    }

    function scaleTriggerToInt(v) {
        return Math.round(v*1023);
    }

    // Connect to gamepad to get button states, separate from main BLE connection
    function connectGamepadWithPinsimID(retries=3) {
        if (pinsimID === null) return

        const gamepads = navigator.getGamepads()
        for (let i = 0; i < gamepads.length; i++) {
            const gamepad = gamepads[i]
            if (gamepad) {
                const leftVal = scaleTriggerToInt(gamepad.buttons[leftTriggerIndex].value)
                const rightVal = scaleTriggerToInt(gamepad.buttons[rightTriggerIndex].value)
                const gp_pinsimID = ((leftVal & 0b0000111100) << 2) | ((rightVal & 0b0000111100) >> 2)
                if (gp_pinsimID === pinsimID) {
                    gamepadIndex = i
                    showAllowedDevices()
                }
            }
        }
        if (gamepadIndex === null && retries > 0) {
            setTimeout(() => { connectGamepadWithPinsimID(retries - 1) }, 500)
        }
    }

    /////////////////////////////////////
    // Command and Response functions

    function sendCommand(b0, b1=null, b2=null) {
        if (cmdCharacteristic) {
            console.log(`Sending Command ${b0} (${b1}, ${b2})`)
            let arr
            if (b1 === null) {
                arr = new Uint8Array([b0])
            }
            else if (b2 === null) {
                arr = new Uint8Array([b0, b1])
            }
            else {
                arr = new Uint8Array([b0, b1, b2])
            }
            cmdCharacteristic.writeValueWithoutResponse(arr)
        }
    }

    function onResponse(event) {
        let value = event.target.value
        if (value.byteLength >= 1) {
            const command = value.getUint8(0)

            if (command === COMMAND_RESPONSE_STATUS && value.byteLength === 4) {
                console.log(`Command Response: ${command} ${value.getUint8(1)} ${value.getUint8(2)} ${value.getUint8(3)}`)
                // Extract PinSim Status data from command
                pinsimID = value.getUint8(1)
                const numPairs = value.getUint8(2)
                const flags = value.getUint8(3)
                plungerOnLeftStick = (flags & COMMAND_STATUS_PLUNGER_CONTROL_RIGHT)
                solenoidEnabled = (flags & COMMAND_STATUS_SOLENOIDS_ENABLED)
                keyboardMode = (flags & COMMAND_STATUS_KEYBOARD_MODE)

                pairingsStatusElement.innerHTML = numPairs
                plungerStickStatusElement.innerHTML = plungerOnLeftStick ? "Left" : "Right"
                solenoidsStatusElement.innerHTML = solenoidEnabled ? "On" : "Off"

                showAllowedDevices()
                if (keyboardMode) {
                    keyMappingCommandsElement.classList.remove("disabled")
                }
                else {
                    keyMappingCommandsElement.classList.add("disabled")
                }
                displayName = `PinSim ${keyboardMode?"Keyboard":"Gamepad"}: ${pinsimID}`
                localStorage.setItem(`PinSimDisplayName-${cmdDevice.id}`, displayName)
                pinsimLabelElement.innerHTML = ` (${displayName})`
                if (gamepadIndex === null) {
                    connectGamepadWithPinsimID()
                }
            }
            else if (command === COMMAND_RESPONSE_KEYMAP && value.byteLength === 17) {
                let dataString = ""
                for (let i = 0; i < 16; i++) { dataString += value.getUint8(i+1) + " " }
                console.log(`Command Response: ${command} ${dataString}`)
                for (let i = 0; i < 16; i++) {
                    let substitution = keyCodeMap[value.getUint8(i+1)]
                    if (substitution) {
                        keyMap[i] = substitution
                    }
                    else {
                        keyMap[i] = String.fromCharCode(value.getUint8(i+1))
                    }
                }
                displayKeys()
            }
        }
    }

    /////////////////////////////////////
    // Display Button Status and Run Key Mapping Process

    function setKeyMapUI(val) {
        if (!keyboardMode) return

        if (val === 0) {
            kbGetKeyMode = 0
            kbGetKeyData = [null, null]
            for (let i=0; i<keyMapButtonOrder.length; i++) {
                document.getElementById(keyMapButtonOrder[i]).classList.remove("keyMap")
            }
            startMappingKeysElement.classList.remove("disabled")
            endMappingKeysElement.style.display = "none"
        }
        if (val === 1) {
            kbGetKeyMode = 1
            if (cmdCharacteristic && keyboardMode) {
                for (let i=0; i<keyMapButtonOrder.length; i++) {
                    document.getElementById(keyMapButtonOrder[i]).classList.add("keyMap")
                }
            }
            startMappingKeysElement.classList.add("disabled")
            endMappingKeysElement.style.display = "inline-block"
        }
        else if (val === 2) {
            kbGetKeyMode = 2
            for (let i=0; i<keyMapButtonOrder.length; i++) {
                if (i != kbGetKeyData[0]) {
                    document.getElementById(keyMapButtonOrder[i]).classList.remove("keyMap")
                }
            }
        }
        else if (val === 3) {
            document.getElementById(keyMapButtonOrder[kbGetKeyData[0]]).classList.remove("keyMap")
            sendCommand(COMMAND_SET_KEY_MAPPING, kbGetKeyData[0], kbGetKeyData[1])
            kbGetKeyData = [null, null]
            setKeyMapUI(1)
        }
    }

    function onClickButton(e, b, isDouble) {
        if (keyboardMode && isDouble) {
            setKeyMapUI(1)
            kbGetKeyData[0] = b
            setKeyMapUI(2)
        }
        else if (keyboardMode && kbGetKeyMode === 1) {
            kbGetKeyData[0] = b
            setKeyMapUI(2)
        }
        e.stopPropagation()
        e.preventDefault()
    }

    // There are no events for gamepad button press/release, so poll every animation frame instead
    function updateGamepadState() {
        requestAnimationFrame(updateGamepadState);
        if (gamepadIndex !== null) {
            let gamepad = null
            gamepad = navigator.getGamepads()[gamepadIndex]
            if (gamepad) {
                const newTimestamp = Math.round(gamepad.timestamp)
                if (newTimestamp === lastTimestamp) return
                lastTimestamp = newTimestamp

                // Update buttons
                for (let i = 0; i < buttonMap.length; i++) {
                    const buttonName = buttonMap[i]
                    if (buttonName) {
                        if (gamepad.buttons[i].pressed) {
                            document.getElementById(buttonName).classList.add("pressed")
                        } else {
                            document.getElementById(buttonName).classList.remove("pressed")
                        }
                    }
                }

                // Update Plunger
                updateStick(leftStickElement, gamepad.axes[0], gamepad.axes[1], 40)
                updateStick(rightStickElement, 0, gamepad.axes[3], 100)
            }
            else if (!keyboardMode) {
                updateStick(leftStickElement, 0, 0, 40)
                updateStick(rightStickElement, 0, 0, 100)
            }
        }
    }
    requestAnimationFrame(updateGamepadState)

    function onKeyDown(event) {
        if (cmdCharacteristic && keyboardMode) {
            if (kbGetKeyMode === 2) {
                let key = event.key
                if (modifierKeys.includes(key)) key = event.code
                if (keyCodeMapInv[key]) {
                    kbGetKeyData[1] = keyCodeMapInv[key]
                }
                else {
                    kbGetKeyData[1] = key.charCodeAt(0)
                }
                setKeyMapUI(3)
                event.stopPropagation()
                event.preventDefault()
            }
            else {
                let key = event.key
                if (modifierKeys.includes(key)) key = event.code
                const index = keyMap.indexOf(key)
                if (index >= 0) {
                    if (keyMapButtonOrder[index] === "plunger") {
                        updateStick(rightStickElement, 0, 1, 100)
                    } else {
                        document.getElementById(keyMapButtonOrder[index]).classList.add("pressed")
                    }
                    event.stopPropagation()
                    event.preventDefault()
                }
            }
        }
    }

    function onKeyUp(event) {
        if (keyboardMode && kbGetKeyMode === 1) {
            if (event.key === "Escape") {
                setKeyMapUI(0)
            }
        }
        else if (cmdCharacteristic && keyboardMode) {
            let key = event.key
            if (modifierKeys.includes(key)) key = event.code
            const index = keyMap.indexOf(key)
            if (index >= 0) {
                if (keyMapButtonOrder[index] === "plunger") {
                    updateStick(rightStickElement, 0, 0, 100)
                } else {
                    document.getElementById(keyMapButtonOrder[index]).classList.remove("pressed")
                }
                event.stopPropagation()
                event.preventDefault()
            }
        }
    }

    function displayKeys() {
        for (let i=0; i<keyMapButtonOrder.length; i++) {
            if (cmdCharacteristic && keyboardMode) {
                let disp = keyMap[i]
                if (keyCodeDisplayMap[disp]) disp = keyCodeDisplayMap[disp]
                document.getElementById(keyMapButtonOrder[i]).getElementsByClassName("key")[0].innerHTML = disp
            }
            else {
                document.getElementById(keyMapButtonOrder[i]).getElementsByClassName("key")[0].innerHTML = ""
            }
        }
    }

    function updateStick(stickElement, x, y, m) {
        // Map the -1.0 to 1.0 range to a -40 to 40 pixel movement for centering the 20px circle in 100px box
        const xOffset = x * m;
        const yOffset = y * m;
        stickElement.style.transform = `translate(${xOffset}px, ${yOffset}px)`;
    }
</script>
</body>
</html>
